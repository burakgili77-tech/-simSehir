<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ƒ∞sim ≈ûehir Online Pro 2026</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --neon: #00f2ff; --glass: rgba(12, 28, 48, 0.98); --border: rgba(0, 242, 255, 0.3); --bg: #010816; --win: #00ff88; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; outline: none; touch-action: manipulation; }
        body, html { height: 100%; width: 100%; background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; position: fixed; }
        #app { width: 92%; max-width: 400px; height: 92vh; background: var(--glass); backdrop-filter: blur(25px); border: 2px solid var(--border); border-radius: 40px; padding: 25px; display: flex; flex-direction: column; position: relative; margin: auto; margin-top: 4vh; z-index: 10; box-shadow: 0 0 40px rgba(0,0,0,0.8); }
        .menu-btn { background: rgba(255, 255, 255, 0.08); border: 1px solid var(--border); color: #fff; padding: 16px; border-radius: 20px; font-size: 14px; font-weight: 800; cursor: pointer; margin-bottom: 12px; width: 100%; display: block; text-transform: uppercase; transition: 0.2s; text-align: center; }
        .menu-btn:active { background: var(--neon); color: #000; transform: scale(0.96); }
        .btn-main { background: var(--neon); color: #000 !important; border: none; box-shadow: 0 0 15px rgba(0,242,255,0.4); }
        .btn-back { background: rgba(255,0,85,0.15); color: #ff0055; border: 1px solid #ff0055; margin-top: auto; }
        .logo { font-size: 28px; font-weight: 900; text-align: center; margin-bottom: 25px; text-shadow: 0 0 15px var(--neon); letter-spacing: 2px; }
        .screen { display: flex; flex-direction: column; height: 100%; width: 100%; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .scroll-v { flex: 1; overflow-y: auto; margin: 10px 0; padding-right: 5px; scrollbar-width: none; }
        .input-box { width: 100%; background: rgba(0,0,0,0.6); border: 1px solid var(--border); padding: 14px; border-radius: 15px; color: white; margin-bottom: 15px; text-align: center; font-size: 16px; }
        .row-item { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 12px; border-radius: 18px; margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.05); }
        .vote-card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 20px; margin-bottom: 10px; border: 1px solid var(--border); }
        .hidden { display: none !important; }
        .active-ok { background: var(--win) !important; color: #000 !important; }
        .active-no { background: #ff0055 !important; color: #fff !important; }
    </style>
</head>
<body>

<div id="app">
    <div id="sc-main" class="screen">
        <div style="font-size:30px; text-align:center;">ü¶Å üåç üì¶</div>
        <div class="logo" data-lang="title">ƒ∞Sƒ∞M ≈ûEHƒ∞R</div>
        <div class="scroll-v">
            <input type="text" id="p-name" class="input-box" data-lang-placeholder="placeholder" placeholder="ƒ∞Sƒ∞M Gƒ∞R">
            <button class="menu-btn btn-main" onclick="initRoom(true)" data-lang="create">OPEN ROOM</button>
            <button class="menu-btn" onclick="nav('sc-join')" data-lang="join">KATIL</button>
            <button class="menu-btn" onclick="nav('sc-settings')" data-lang="settings">‚öôÔ∏è AYARLAR</button>
        </div>
    </div>

    <div id="sc-game" class="screen hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <div id="let" style="font-size:36px; font-weight:900; color:var(--neon);">A</div>
            <div id="timer" style="font-size:24px; font-weight:bold;">60</div>
        </div>
        <div class="scroll-v" id="inputs-area"></div>
        <button id="finish-btn" class="menu-btn btn-main" onclick="submitAnswers()">Bƒ∞TTƒ∞! (0/0)</button>
        <button class="menu-btn btn-back" onclick="backToLobby()" data-lang="back">LOBƒ∞YE D√ñN</button>
    </div>

    <div id="sc-lobby" class="screen hidden">
        <div style="text-align:center;"><small data-lang="room_code">KOD:</small> <b id="display-code" style="color:var(--neon)">-</b></div>
        <div class="scroll-v" id="lobby-players"></div>
        <div id="lobby-admin-controls" class="hidden">
            <small><span data-lang="time_label">S√úRE</span>: <span id="time-val">60</span>s</small>
            <input type="range" id="time-slider" min="30" max="240" step="10" value="60" oninput="document.getElementById('time-val').innerText = this.value" style="width:100%; margin:10px 0;">
            <div id="lobby-cats" style="max-height:100px; overflow-y:auto; border:1px solid var(--border); border-radius:15px; padding:10px; margin-bottom:10px;"></div>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <input type="text" id="cat-in" class="input-box" style="margin:0; flex:1;" data-lang-placeholder="cat_placeholder" placeholder="KATEGORƒ∞">
                <button class="menu-btn btn-main" onclick="addCat()" style="margin:0; width:45px;">+</button>
            </div>
            <button class="menu-btn btn-main" onclick="startGameTrigger()" data-lang="start">BA≈ûLAT</button>
        </div>
        <div id="lobby-waiting" class="hidden" style="text-align:center; padding:20px; color:var(--neon);" data-lang="waiting">BEKLENƒ∞YOR...</div>
        <button class="menu-btn btn-back" onclick="resetGame(true)" data-lang="menu">AYRIL / √áIKI≈û</button>
    </div>

    <div id="sc-settings" class="screen hidden">
        <h3 style="text-align:center; color:var(--neon); margin-bottom:20px;" data-lang="settings">AYARLAR</h3>
        <button id="lang-btn" class="menu-btn btn-main" onclick="switchLang()">Dƒ∞L: TR</button>
        <button class="menu-btn" onclick="nav('sc-main')" data-lang="back">GERƒ∞</button>
    </div>

    <div id="sc-join" class="screen hidden">
        <h3 style="text-align:center; margin-bottom:20px;" data-lang="join_title">ODAYA KATIL</h3>
        <input type="text" id="join-code" class="input-box" data-lang-placeholder="code_placeholder" placeholder="ODA KODU" style="text-transform:uppercase;">
        <button class="menu-btn btn-main" onclick="initRoom(false)" data-lang="join">KATIL</button>
        <button class="menu-btn" onclick="nav('sc-main')" data-lang="back">GERƒ∞</button>
    </div>

    <div id="sc-review" class="screen hidden">
        <h3 style="text-align:center; color:var(--neon); margin-bottom:10px;" data-lang="review_title">OYLAMA</h3>
        <div class="scroll-v" id="all-reviews-list"></div>
        <button id="admin-results-btn" class="menu-btn btn-main hidden" onclick="showLeaderboard()" data-lang="see_results">SONU√áLAR</button>
    </div>

    <div id="sc-results" class="screen hidden">
        <h3 style="text-align:center; color:var(--neon);" data-lang="results">üèÜ SKORLAR</h3>
        <div class="scroll-v" id="final-ranks"></div>
        <button class="menu-btn btn-main" onclick="backToLobby()" data-lang="menu">LOBƒ∞YE D√ñN</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBXIpV169nwxWT8fOYaA7NK5jcqmlw64Yg",
        authDomain: "isimsehironline-af2bd.firebaseapp.com",
        databaseURL: "https://isimsehironline-af2bd-default-rtdb.firebaseio.com",
        projectId: "isimsehironline-af2bd",
        storageBucket: "isimsehironline-af2bd.firebasestorage.app",
        messagingSenderId: "737781646979",
        appId: "1:737781646979:web:c1c8f86d90517d9036fdb6"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let curLang = 'tr', myName = "", myRoomCode = "", isAdmin = false, roomPlayers = [], 
        currentCats = ["ƒ∞Sƒ∞M", "≈ûEHƒ∞R", "HAYVAN", "Bƒ∞TKƒ∞", "E≈ûYA"], timerInt, 
        currentLetter = "", localTime = 60, currentStatus = "";
    
    const langDict = {
        tr: { title:"ƒ∞Sƒ∞M ≈ûEHƒ∞R", create:"OPEN ROOM", join:"KATIL", settings:"AYARLAR", start:"BA≈ûLAT", placeholder:"ƒ∞Sƒ∞M Gƒ∞R", join_title:"ODAYA KATIL", code_placeholder:"ODA KODU", back:"GERƒ∞ / LOBƒ∞", room_code:"KOD:", finish:"Bƒ∞TTƒ∞!", results:"üèÜ SKORLAR", menu:"ANA MEN√ú", time_label:"S√úRE", cat_placeholder:"KATEGORƒ∞", review_title:"OYLAMA", see_results:"SONU√áLAR", waiting:"BEKLENƒ∞YOR...", red:"RED", ok:"TAMAM" },
        en: { title:"NAME CITY", create:"OPEN ROOM", join:"JOIN", settings:"SETTINGS", start:"START", placeholder:"ENTER NAME", join_title:"JOIN ROOM", code_placeholder:"ROOM CODE", back:"BACK / LOBBY", room_code:"CODE:", finish:"FINISH!", results:"üèÜ SCORES", menu:"MAIN MENU", time_label:"TIME", cat_placeholder:"CATEGORY", review_title:"VOTING", see_results:"RESULTS", waiting:"WAITING FOR ADMIN...", red:"NO", ok:"OK" }
    };

    function nav(id) { 
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden')); 
        document.getElementById(id).classList.remove('hidden'); 
        updateUILanguage(); 
    }

    function switchLang() { 
        curLang = (curLang === 'tr') ? 'en' : 'tr'; 
        document.getElementById('lang-btn').innerText = curLang === 'tr' ? "Dƒ∞L: TR" : "LANG: EN"; 
        updateUILanguage(); 
    }

    function updateUILanguage() { 
        document.querySelectorAll('[data-lang]').forEach(el => { 
            const key = el.getAttribute('data-lang'); 
            if(langDict[curLang][key]) el.innerText = langDict[curLang][key]; 
        }); 
        document.querySelectorAll('[data-lang-placeholder]').forEach(el => { 
            const key = el.getAttribute('data-lang-placeholder'); 
            if(langDict[curLang][key]) el.placeholder = langDict[curLang][key]; 
        }); 
    }

    async function initRoom(host) {
        const inputName = document.getElementById('p-name').value.trim().toUpperCase();
        if(!inputName) return alert(curLang === 'tr' ? "ƒ∞sim?" : "Name?");
        myName = inputName;
        isAdmin = host;
        if(host) {
            myRoomCode = Math.random().toString(36).substr(2,4).toUpperCase();
            await db.ref('rooms/' + myRoomCode).set({ status: 'lobby', admin: myName, cats: currentCats, time: 60, letter: 'A', finishedCount: 0 });
        } else {
            myRoomCode = document.getElementById('join-code').value.toUpperCase().trim();
            const snap = await db.ref('rooms/' + myRoomCode).once('value');
            if(!snap.exists()) return alert(curLang === 'tr' ? "Oda yok!" : "No room!");
        }
        db.ref(`rooms/${myRoomCode}/players/${myName}`).set({ score: 0 });
        db.ref(`rooms/${myRoomCode}/players/${myName}`).onDisconnect().remove();
        document.getElementById('display-code').innerText = myRoomCode;
        isAdmin ? document.getElementById('lobby-admin-controls').classList.remove('hidden') : document.getElementById('lobby-waiting').classList.remove('hidden');
        nav('sc-lobby');
        listenRoom();
    }

    function listenRoom() {
        const rRef = db.ref(`rooms/${myRoomCode}`);
        rRef.child('players').on('value', snap => { 
            roomPlayers = Object.keys(snap.val() || {}); 
            document.getElementById('lobby-players').innerHTML = roomPlayers.map(p => `<div class="row-item"><span>üë§ ${p}</span></div>`).join(''); 
        });
        rRef.child('status').on('value', s => { 
            const st = s.val();
            if(st === currentStatus) return;
            currentStatus = st;
            if(st === 'playing') startGameUI(); 
            if(st === 'review') startReviewUI();
            if(st === 'results') showLeaderboard();
            if(st === 'lobby') nav('sc-lobby');
        });
        rRef.child('cats').on('value', snap => {
            currentCats = snap.val() || [];
            document.getElementById('lobby-cats').innerHTML = currentCats.map((c,i) => `<div class="row-item"><span>${c}</span>${isAdmin ? `<button onclick="removeCat(${i})">‚úï</button>` : ''}</div>`).join('');
        });
        rRef.child('time').on('value', snap => { 
            localTime = snap.val(); 
            if(document.getElementById('timer')) document.getElementById('timer').innerText = localTime; 
            if(localTime <= 0 && isAdmin && currentStatus === 'playing') db.ref(`rooms/${myRoomCode}`).update({ status: 'review' });
        });
        rRef.child('finishedCount').on('value', snap => { 
            const count = snap.val() || 0;
            const btn = document.getElementById('finish-btn');
            if(btn) btn.innerText = `${langDict[curLang].finish} (${count}/${roomPlayers.length})`;
            if(roomPlayers.length > 0 && count >= roomPlayers.length && isAdmin && currentStatus === 'playing') {
                db.ref(`rooms/${myRoomCode}`).update({ status: 'review' });
            }
        });
    }

    function startGameTrigger() {
        const letter = "ABC√áDEFGƒûHIƒ∞JKLMNO√ñPRS≈ûTU√úVYZ"[Math.floor(Math.random()*29)];
        db.ref(`rooms/${myRoomCode}`).update({ 
            status: 'playing', 
            letter: letter, 
            time: parseInt(document.getElementById('time-slider').value), 
            finishedCount: 0, 
            answers: null, 
            votes: null
        });
    }

    function startGameUI() {
        db.ref(`rooms/${myRoomCode}`).once('value', snap => {
            const data = snap.val();
            currentLetter = data.letter;
            document.getElementById('let').innerText = currentLetter;
            document.getElementById('inputs-area').innerHTML = data.cats.map(c => `
                <div style="margin-bottom:12px;">
                    <small style="color:var(--neon)">${c}</small>
                    <input type="text" id="ans-${c.replace(/\s/g,'_')}" class="input-box" style="text-align:left; margin:0; text-transform:uppercase;">
                </div>`).join('');
            const btn = document.getElementById('finish-btn');
            btn.disabled = false; btn.style.opacity = "1";
            nav('sc-game');
            if(isAdmin) {
                clearInterval(timerInt);
                timerInt = setInterval(() => {
                    db.ref(`rooms/${myRoomCode}/time`).transaction(t => (t > 0) ? t - 1 : 0);
                }, 1000);
            }
        });
    }

    function submitAnswers() {
        const btn = document.getElementById('finish-btn');
        if(btn.disabled) return;
        
        const answers = {};
        currentCats.forEach(c => { 
            const val = document.getElementById('ans-' + c.replace(/\s/g,'_')).value.trim().toUpperCase(); 
            if(val && val.startsWith(currentLetter)) {
                answers[c] = val;
            } else {
                answers[c] = "-";
            }
        });
        
        btn.disabled = true; 
        btn.style.opacity = "0.5";
        
        db.ref(`rooms/${myRoomCode}/answers/${myName}`).set(answers);
        db.ref(`rooms/${myRoomCode}/finishedCount`).transaction(c => (c || 0) + 1);
    }

    function backToLobby() {
        if (currentStatus === 'playing' && !confirm(curLang === 'tr' ? "Ayrƒ±l?" : "Leave?")) return;
        clearInterval(timerInt);
        if(isAdmin) db.ref(`rooms/${myRoomCode}`).update({ status: 'lobby' });
        nav('sc-lobby');
    }

    function addCat() {
        const c = document.getElementById('cat-in').value.toUpperCase().trim();
        if(c && !currentCats.includes(c)) {
            currentCats.push(c);
            db.ref(`rooms/${myRoomCode}/cats`).set(currentCats);
            document.getElementById('cat-in').value = "";
        }
    }
    function removeCat(i) { currentCats.splice(i,1); db.ref(`rooms/${myRoomCode}/cats`).set(currentCats); }

    function startReviewUI() {
        clearInterval(timerInt);
        db.ref(`rooms/${myRoomCode}/answers`).once('value', snap => {
            const allAns = snap.val() || {}; let html = "";
            currentCats.forEach(cat => {
                html += `<div style="color:var(--neon); font-size:12px; font-weight:900; margin:15px 5px 5px 5px;">‚óè ${cat}</div>`;
                roomPlayers.forEach(p => {
                    const ans = (allAns[p] && allAns[p][cat]) ? allAns[p][cat] : "-";
                    const sid = `${cat.replace(/\s/g,'_')}_${p.replace(/\s/g,'_')}`;
                    html += `
                    <div class="vote-card">
                        <div style="display:flex; justify-content:space-between;"><small>üë§ ${p}</small> <span id="vcount-${sid}">‚úî0 ‚úñ0</span></div>
                        <div style="font-size:18px; font-weight:bold; margin:10px 0;">${ans}</div>
                        <div style="display:flex; gap:10px;">
                            <button class="menu-btn" style="flex:1; margin:0;" onclick="vote('${p}','${cat}','no', this)">${langDict[curLang].red}</button>
                            <button class="menu-btn" style="flex:1; margin:0;" onclick="vote('${p}','${cat}','ok', this)">${langDict[curLang].ok}</button>
                        </div>
                    </div>`;
                });
            });
            document.getElementById('all-reviews-list').innerHTML = html;
            if(isAdmin) document.getElementById('admin-results-btn').classList.remove('hidden');
            nav('sc-review');
            db.ref(`rooms/${myRoomCode}/votes`).on('value', snap => { const all = snap.val() || {}; Object.keys(all).forEach(sid => { const v = Object.values(all[sid]); const el = document.getElementById(`vcount-${sid}`); if(el) el.innerText = `‚úî${v.filter(x=>x==='ok').length} ‚úñ${v.filter(x=>x==='no').length}`; }); });
        });
    }

    function vote(t, c, type, btn) {
        const sid = `${c.replace(/\s/g,'_')}_${t.replace(/\s/g,'_')}`;
        btn.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('active-ok', 'active-no'));
        btn.classList.add(type === 'ok' ? 'active-ok' : 'active-no');
        db.ref(`rooms/${myRoomCode}/votes/${sid}/${myName}`).set(type);
    }

    async function showLeaderboard() {
        if(isAdmin) db.ref(`rooms/${myRoomCode}`).update({ status: 'results' });
        const snap = await db.ref(`rooms/${myRoomCode}`).once('value');
        const vts = snap.val().votes || {};
        let scores = {}; roomPlayers.forEach(p => scores[p] = 0);
        Object.keys(vts).forEach(vid => { 
            const parts = vid.split('_');
            const target = parts[parts.length-1].replace(/_/g, ' '); 
            const v = Object.values(vts[vid]); 
            if(v.filter(x=>x==='ok').length >= v.filter(x=>x==='no').length) scores[target] = (scores[target] || 0) + 10; 
        });
        document.getElementById('final-ranks').innerHTML = Object.entries(scores).sort((a,b)=>b[1]-a[1]).map(s => `<div class="row-item"><span>${s[0]}</span><b>${s[1]} P</b></div>`).join('');
        confetti(); nav('sc-results');
    }

    function resetGame(ask) {
        if(ask && !confirm(curLang === 'tr' ? "√áƒ±kƒ±≈ü?" : "Exit?")) return;
        try { if(myRoomCode) db.ref(`rooms/${myRoomCode}/players/${myName}`).remove(); } catch(e){}
        location.reload();
    }
</script>
</body>
</html>

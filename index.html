<!DOCTYPE html>
<html lang="tr">
<head>
<link rel="manifest" href="manifest.json">
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ƒ∞sim ≈ûehir Online Pro 2026</title>
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <style>
        :root { --neon: #00f2ff; --glass: rgba(12, 28, 48, 0.98); --border: rgba(0, 242, 255, 0.3); --bg: #010816; --win: #00ff88; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; outline: none; touch-action: manipulation; }
        body, html { height: 100%; width: 100%; background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; position: fixed; }
        
        #app { 
            width: 96%; max-width: 420px; 
            height: calc(100vh - 80px); 
            margin-top: 20px; 
            background: var(--glass); backdrop-filter: blur(25px); 
            border: 2px solid var(--border); border-radius: 25px; padding: 20px; 
            display: flex; flex-direction: column; position: relative; 
            margin-left: auto; margin-right: auto; z-index: 10; 
            box-shadow: 0 0 40px rgba(0,0,0,0.8); 
        }

        .menu-btn { background: rgba(255, 255, 255, 0.08); border: 1px solid var(--border); color: #fff; padding: 14px; border-radius: 18px; font-size: 14px; font-weight: 800; cursor: pointer; margin-bottom: 10px; width: 100%; display: block; text-transform: uppercase; transition: 0.2s; text-align: center; flex-shrink: 0; }
        .menu-btn:active { background: var(--neon); color: #000; transform: scale(0.96); }
        .btn-main { background: var(--neon); color: #000 !important; border: none; box-shadow: 0 0 15px rgba(0,242,255,0.4); }
        .btn-back { background: rgba(255,0,85,0.15); color: #ff0055; border: 1px solid #ff0055; }
        .logo { font-size: 26px; font-weight: 900; text-align: center; margin-bottom: 20px; text-shadow: 0 0 15px var(--neon); letter-spacing: 2px; flex-shrink: 0; }
        
        .screen { display: flex; flex-direction: column; height: 100%; width: 100%; animation: fadeIn 0.2s ease-out; overflow: hidden; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .scroll-v { flex: 1; overflow-y: auto; margin: 5px 0; padding-right: 5px; scrollbar-width: none; min-height: 0; }
        
        .input-box { width: 100%; background: rgba(0,0,0,0.6); border: 1px solid var(--border); padding: 12px; border-radius: 15px; color: white; margin-bottom: 12px; text-align: center; font-size: 16px; }
        .row-item { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 15px; margin-bottom: 6px; border: 1px solid rgba(255,255,255,0.05); }
        .vote-card { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 18px; margin-bottom: 8px; border: 1px solid var(--border); }
        .hidden { display: none !important; }
        
        .active-ok { background: var(--win) !important; color: #000 !important; box-shadow: 0 0 15px rgba(0,255,136,0.4); border: 1px solid var(--win) !important; transition: none !important; }
        .active-no { background: #ff0055 !important; color: #fff !important; box-shadow: 0 0 15px rgba(255,0,85,0.4); border: 1px solid #ff0055 !important; transition: none !important; }

        #confirm-modal { position: fixed; left: 0; top: 0; right: 0; bottom: 0; display:flex; align-items:center; justify-content:center; background: rgba(0,0,0,0.6); z-index: 9999; }
        #confirm-box { background: var(--glass); border: 2px solid var(--border); padding: 18px; border-radius: 14px; width: 90%; max-width: 360px; text-align:center; color: #fff; box-shadow: 0 0 30px rgba(0,0,0,0.7); }
        #confirm-msg { margin-bottom: 12px; font-weight:700; color: var(--neon); }
        .confirm-row { display:flex; gap:8px; justify-content:space-between; }
        .confirm-row .menu-btn { flex:1; margin:0; }

        #ad-loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="app">
    <div id="sc-main" class="screen">
        <div style="font-size:30px; text-align:center;">ü¶Å üåç üì¶</div>
        <div class="logo" data-lang="title">ƒ∞Sƒ∞M ≈ûEHƒ∞R</div>
        <div class="scroll-v">
            <input type="text" id="p-name" class="input-box" data-lang-placeholder="placeholder" placeholder="ƒ∞Sƒ∞M Gƒ∞R">
            <button id="create-room-trigger" class="menu-btn btn-main" data-lang="create">üì∫ ODA KUR (REKLAM ƒ∞ZLE)</button>
            
            <button class="menu-btn" id="join-nav-btn" data-lang="join">KATIL</button>
            <button class="menu-btn" id="settings-nav-btn" data-lang="settings">‚öôÔ∏è AYARLAR</button>
        </div>
    </div>

    <div id="sc-game" class="screen hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; flex-shrink:0;">
            <div id="let" style="font-size:36px; font-weight:900; color:var(--neon);">A</div>
            <div id="timer" style="font-size:24px; font-weight:bold;">60</div>
        </div>
        <div class="scroll-v" id="inputs-area"></div>
        <button id="finish-btn" class="menu-btn btn-main">Bƒ∞TTƒ∞! (0/0)</button>
        <button class="menu-btn btn-back" id="back-from-game" data-lang="back">LOBƒ∞YE D√ñN</button>
    </div>

    <div id="sc-lobby" class="screen hidden">
        <div style="text-align:center; flex-shrink:0;"><small data-lang="room_code">KOD:</small> <b id="display-code" style="color:var(--neon)">-</b></div>
        <div id="lobby-myname" style="text-align:center; margin:8px 0; color:var(--neon); font-weight:800; flex-shrink:0;"></div>
        
        <div class="scroll-v">
            <div id="lobby-players"></div>
            <div id="lobby-cats" style="max-height:150px; overflow-y:auto; border:1px solid var(--border); border-radius:15px; padding:10px; margin-bottom:10px;"></div>
            
            <div id="lobby-admin-controls" class="hidden">
                <small><span data-lang="time_label">S√úRE</span>: <span id="time-val">60</span>s</small>
                <input type="range" id="time-slider" min="30" max="240" step="10" value="60" oninput="document.getElementById('time-val').innerText = this.value" style="width:100%; margin:10px 0;">
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <input type="text" id="cat-in" class="input-box" style="margin:0; flex:1;" data-lang-placeholder="cat_placeholder" placeholder="KATEGORƒ∞">
                    <button id="add-cat-btn" class="menu-btn btn-main" style="margin:0; width:45px;">+</button>
                </div>
                <button id="start-game-btn" class="menu-btn btn-main" data-lang="start">BA≈ûLAT</button>
            </div>
            <div id="lobby-waiting" class="hidden" style="text-align:center; padding:20px; color:var(--neon);" data-lang="waiting">BEKLENƒ∞YOR...</div>
        </div>
        
        <button id="leave-btn" class="menu-btn btn-back" data-lang="menu">AYRIL / √áIKI≈û</button>
    </div>

    <div id="sc-settings" class="screen hidden">
        <h3 style="text-align:center; color:var(--neon); margin-bottom:20px; flex-shrink:0;" data-lang="settings">AYARLAR</h3>
        <div class="scroll-v">
            <button id="lang-btn" class="menu-btn btn-main">Dƒ∞L: TR</button>
        </div>
        <button class="menu-btn" id="settings-back-btn" data-lang="back">GERƒ∞</button>
    </div>

    <div id="sc-join" class="screen hidden">
        <h3 style="text-align:center; margin-bottom:20px; flex-shrink:0;" data-lang="join_title">ODAYA KATIL</h3>
        <div class="scroll-v">
            <input type="text" id="join-code" class="input-box" data-lang-placeholder="code_placeholder" placeholder="ODA KODU" style="text-transform:uppercase;">
            <button id="join-room-btn" class="menu-btn btn-main" data-lang="join">KATIL</button>
        </div>
        <button class="menu-btn" id="join-back-btn" data-lang="back">GERƒ∞</button>
    </div>

    <div id="sc-review" class="screen hidden">
        <h3 style="text-align:center; color:var(--neon); margin-bottom:10px; flex-shrink:0;" data-lang="review_title">OYLAMA</h3>
        <div class="scroll-v" id="all-reviews-list"></div>
        <button id="admin-results-btn" class="menu-btn btn-main hidden" data-lang="see_results">SONU√áLAR</button>
    </div>

    <div id="sc-results" class="screen hidden">
        <h3 style="text-align:center; color:var(--neon); flex-shrink:0;" data-lang="results">üèÜ SKORLAR</h3>
        <div class="scroll-v" id="final-ranks"></div>
        <button class="menu-btn btn-main" id="results-back-btn" data-lang="back">LOBƒ∞YE D√ñN</button>
    </div>
</div>

<div id="confirm-modal" class="hidden" aria-hidden="true">
    <div id="confirm-box">
        <div id="confirm-msg">EMƒ∞N Mƒ∞Sƒ∞N?</div>
        <div class="confirm-row" style="margin-top:6px;">
            <button id="confirm-no" class="menu-btn">HAYIR</button>
            <div style="width:8px"></div>
            <button id="confirm-yes" class="menu-btn btn-main">EVET</button>
        </div>
    </div>
</div>

<div id="ad-loading-overlay" class="hidden">
    <div style="color:var(--neon); font-size:20px;">REKLAM Y√úKLENƒ∞YOR...</div>
</div>

<script>
    // --- ADMOB AYARLARI ---
    document.addEventListener('deviceready', initAdMob, false);

    function initAdMob() {
        if (typeof admob === 'undefined') {
            console.log('AdMob plugini bulunamadƒ±.');
            return;
        }

        // 1. BANNER REKLAM (Alt kƒ±sƒ±m) - Google Test ID (Android)
        admob.banner.config({
            id: 'ca-app-pub-3940256099942544/6300978111', 
            autoShow: true,
            overlap: false 
        });
        admob.banner.prepare();

        // 2. √ñD√úLL√ú REKLAM (Video) - Google Test ID (Android)
        admob.rewardvideo.config({
            id: 'ca-app-pub-3940256099942544/5224354917'
        });
        admob.rewardvideo.prepare(); 
    }

    // --- FIREBASE AYARLARI ---
    const firebaseConfig = {
        apiKey: "AIzaSyBXIpV169nwxWT8fOYaA7NK5jcqmlw64Yg",
        authDomain: "isimsehironline-af2bd.firebaseapp.com",
        databaseURL: "https://isimsehironline-af2bd-default-rtdb.firebaseio.com",
        projectId: "isimsehironline-af2bd",
        storageBucket: "isimsehironline-af2bd.firebasestorage.app",
        messagingSenderId: "737781646979",
        appId: "1:737781646979:web:c1c8f86d90517d9036fdb6"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let curLang = 'tr', myName = "", myRoomCode = "", isAdmin = false, roomPlayers = [],
        currentCats = ["ƒ∞Sƒ∞M", "≈ûEHƒ∞R", "HAYVAN", "Bƒ∞TKƒ∞", "E≈ûYA"], timerInt,
        currentLetter = "", localTime = 60, currentStatus = "", prevRoomRef = null;

    let votesRef = null, votesListener = null;
    const localVotes = {}; 
    let confirmOpen = false;

    const langDict = {
        tr: { title:"ƒ∞Sƒ∞M ≈ûEHƒ∞R", create:"ODA KUR (REKLAM)", join:"KATIL", settings:"AYARLAR", start:"BA≈ûLAT", placeholder:"ƒ∞Sƒ∞M Gƒ∞R", join_title:"ODAYA KATIL", code_placeholder:"ODA KODU", back:"GERƒ∞ / LOBƒ∞", room_code:"KOD:", finish:"Bƒ∞TTƒ∞!", results:"üèÜ SKORLAR", menu:"ANA MEN√ú", time_label:"S√úRE", cat_placeholder:"KATEGORƒ∞", review_title:"OYLAMA", see_results:"SONU√áLAR", waiting:"BEKLENƒ∞YOR...", red:"RED", ok:"TAMAM", confirm_title:"EMƒ∞N Mƒ∞Sƒ∞N?", confirm_yes:"EVET", confirm_no:"HAYIR" },
        en: { title:"NAME CITY", create:"OPEN ROOM (AD)", join:"JOIN", settings:"SETTINGS", start:"START", placeholder:"ENTER NAME", join_title:"JOIN ROOM", code_placeholder:"ROOM CODE", back:"BACK / LOBBY", room_code:"CODE:", finish:"FINISH!", results:"üèÜ SCORES", menu:"MAIN MENU", time_label:"TIME", cat_placeholder:"CATEGORY", review_title:"VOTING", see_results:"RESULTS", waiting:"WAITING FOR ADMIN...", red:"NO", ok:"OK", confirm_title:"ARE YOU SURE?", confirm_yes:"YES", confirm_no:"NO" }
    };

    const catMapTRtoEN = { "ƒ∞Sƒ∞M":"NAME", "≈ûEHƒ∞R":"CITY", "HAYVAN":"ANIMAL", "Bƒ∞TKƒ∞":"PLANT", "E≈ûYA":"OBJECT" };
    const catMapENtoTR = Object.fromEntries(Object.entries(catMapTRtoEN).map(([k,v])=>[v,k]));

    function displayCat(c) {
        if(!c) return c;
        if(curLang === 'en') return catMapTRtoEN[c] || c;
        return catMapENtoTR[c] || c;
    }

    document.getElementById('create-room-trigger').addEventListener('click', () => {
        const inputName = document.getElementById('p-name').value.trim();
        if(!inputName) return alert(curLang === 'tr' ? "ƒ∞sim giriniz!" : "Enter name!");

        if (typeof admob !== 'undefined') {
            const loadingOv = document.getElementById('ad-loading-overlay');
            loadingOv.classList.remove('hidden');

            admob.rewardvideo.show().then(() => {
                loadingOv.classList.add('hidden');
                admob.rewardvideo.prepare();
                initRoom(true);
            }).catch(e => {
                loadingOv.classList.add('hidden');
                console.log("Reklam hatasƒ±:", e);
                initRoom(true); 
                admob.rewardvideo.prepare();
            });
        } else {
            initRoom(true);
        }
    });

    document.getElementById('join-nav-btn').addEventListener('click', () => nav('sc-join'));
    document.getElementById('settings-nav-btn').addEventListener('click', () => nav('sc-settings'));
    document.getElementById('join-back-btn').addEventListener('click', () => nav('sc-main'));
    document.getElementById('settings-back-btn').addEventListener('click', () => nav('sc-main'));
    document.getElementById('join-room-btn').addEventListener('click', () => initRoom(false));
    document.getElementById('leave-btn').addEventListener('click', () => goToMainMenu(true));
    document.getElementById('add-cat-btn').addEventListener('click', () => addCat());
    document.getElementById('results-back-btn').addEventListener('click', () => goToRoomLobby());
    document.getElementById('back-from-game').addEventListener('click', () => onBackFromGame());
    document.getElementById('lang-btn').addEventListener('click', () => switchLang());
    document.getElementById('admin-results-btn').addEventListener('click', () => showLeaderboard());
    document.getElementById('start-game-btn').addEventListener('click', () => { if(!isAdmin) return; startGameTrigger(); });
    document.getElementById('finish-btn').addEventListener('click', submitAnswers);

    function updateUILanguage() {
        document.querySelectorAll('[data-lang]').forEach(el => {
            const key = el.getAttribute('data-lang');
            if(langDict[curLang][key]) el.innerText = langDict[curLang][key];
        });
        document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
            const key = el.getAttribute('data-lang-placeholder');
            if(langDict[curLang][key]) el.placeholder = langDict[curLang][key];
        });
        document.getElementById('lang-btn').innerText = curLang === 'tr' ? "Dƒ∞L: TR" : "LANG: EN";
        const btn = document.getElementById('finish-btn');
        if(btn) btn.innerText = `${langDict[curLang].finish} (0/${roomPlayers.length || 0})`;
        const cm = document.getElementById('confirm-msg');
        if(cm) cm.innerText = langDict[curLang].confirm_title;
        const yes = document.getElementById('confirm-yes'); if(yes) yes.innerText = langDict[curLang].confirm_yes;
        const no = document.getElementById('confirm-no'); if(no) no.innerText = langDict[curLang].confirm_no;
        renderLobbyCats();
        renderGameInputsLabels();
        if(currentStatus === 'review') startReviewUI();
    }

    function nav(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); updateUILanguage(); }
    function switchLang() { curLang = (curLang === 'tr') ? 'en' : 'tr'; updateUILanguage(); }

    function showConfirm() {
        if(confirmOpen) return Promise.resolve('no');
        confirmOpen = true;
        const modal = document.getElementById('confirm-modal');
        modal.classList.remove('hidden'); modal.setAttribute('aria-hidden','false');
        document.body.style.pointerEvents = 'none'; modal.style.pointerEvents = 'auto';
        const yes = document.getElementById('confirm-yes'), no = document.getElementById('confirm-no');
        return new Promise(res => {
            const cleanup = (val) => { yes.onclick = null; no.onclick = null; modal.classList.add('hidden'); modal.setAttribute('aria-hidden','true'); document.body.style.pointerEvents = ''; confirmOpen = false; res(val); };
            yes.onclick = () => cleanup('yes'); no.onclick = () => cleanup('no');
        });
    }

    async function initRoom(host) {
        const inputName = document.getElementById('p-name').value.trim().toUpperCase();
        if(!inputName) return alert(curLang === 'tr' ? "ƒ∞sim?" : "Name?");
        myName = inputName; isAdmin = host;
        if(prevRoomRef) { try{ prevRoomRef.off(); }catch(e){} prevRoomRef = null; }
        currentStatus = "";
        if(host) {
            myRoomCode = Math.random().toString(36).substr(2,4).toUpperCase();
            document.getElementById('display-code').innerText = myRoomCode;
            document.getElementById('lobby-myname').innerText = myName;
            document.getElementById('lobby-admin-controls').classList.remove('hidden');
            document.getElementById('lobby-waiting').classList.add('hidden');
            db.ref('rooms/' + myRoomCode).set({ status: 'lobby', admin: myName, cats: currentCats, time: 60, letter: 'A', finishedCount: 0 });
            db.ref(`rooms/${myRoomCode}/players/${myName}`).set({ score: 0 });
            db.ref(`rooms/${myRoomCode}/players/${myName}`).onDisconnect().remove();
            renderLobbyCats(); nav('sc-lobby');
        } else {
            myRoomCode = document.getElementById('join-code').value.toUpperCase().trim();
            const snap = await db.ref('rooms/' + myRoomCode).once('value');
            if(!snap.exists()) return alert(curLang === 'tr' ? "Oda yok!" : "No room!");
            const data = snap.val();
            currentCats = data.cats || currentCats;
            await db.ref(`rooms/${myRoomCode}/players/${myName}`).set({ score: 0 });
            db.ref(`rooms/${myRoomCode}/players/${myName}`).onDisconnect().remove();
            document.getElementById('display-code').innerText = myRoomCode;
            document.getElementById('lobby-myname').innerText = myName;
            document.getElementById('lobby-admin-controls').classList.add('hidden');
            document.getElementById('lobby-waiting').classList.remove('hidden');
            renderLobbyCats(); nav('sc-lobby');
        }
        listenRoom();
    }

    function listenRoom() {
        if(!myRoomCode) return;
        const rRef = db.ref(`rooms/${myRoomCode}`);
        prevRoomRef = rRef;
        rRef.child('players').on('value', snap => {
            const val = snap.val() || {};
            roomPlayers = Object.keys(val);
            document.getElementById('lobby-players').innerHTML = roomPlayers.map(p => `<div class="row-item"><span>üë§ ${p}</span></div>`).join('');
            const btn = document.getElementById('finish-btn');
            if(btn) btn.innerText = `${langDict[curLang].finish} (0/${roomPlayers.length || 0})`;
            if(myName && !roomPlayers.includes(myName)) { db.ref(`rooms/${myRoomCode}/players/${myName}`).set({ score: 0 }); db.ref(`rooms/${myRoomCode}/players/${myName}`).onDisconnect().remove(); }
        });
        rRef.child('status').on('value', s => {
            const st = s.val(); if(st === currentStatus) return; currentStatus = st;
            if(st === 'playing') startGameUI();
            if(st === 'review') startReviewUI();
            if(st === 'results') showLeaderboard();
            if(st === 'lobby') { document.getElementById('lobby-admin-controls').classList.toggle('hidden', !isAdmin); document.getElementById('lobby-waiting').classList.toggle('hidden', isAdmin); nav('sc-lobby'); }
        });
        rRef.child('cats').on('value', snap => { currentCats = snap.val() || []; renderLobbyCats(); renderGameInputsLabels(); });
        rRef.child('time').on('value', snap => { localTime = snap.val() || 0; if(document.getElementById('timer')) document.getElementById('timer').innerText = localTime; if(localTime <= 0 && isAdmin && currentStatus === 'playing') db.ref(`rooms/${myRoomCode}`).update({ status: 'review' }); });
        rRef.child('finishedCount').on('value', snap => {
            const count = snap.val() || 0;
            const btn = document.getElementById('finish-btn');
            if(btn) btn.innerText = `${langDict[curLang].finish} (${count}/${roomPlayers.length || 0})`;
            if(roomPlayers.length > 0 && count >= roomPlayers.length && isAdmin && currentStatus === 'playing') { db.ref(`rooms/${myRoomCode}`).update({ status: 'review' }); }
        });
    }

    function renderLobbyCats() {
        const container = document.getElementById('lobby-cats');
        if(!container) return;
        container.innerHTML = currentCats.map((c,i) => `<div class="row-item"><span>${displayCat(c)}</span>${isAdmin ? `<button onclick="removeCat(${i})">‚úï</button>` : ''}</div>`).join('');
    }

    function renderGameInputsLabels() {
        const inputsArea = document.getElementById('inputs-area');
        if(!inputsArea) return;
        const children = Array.from(inputsArea.children || []);
        if(children.length === 0) return;
        currentCats.forEach((c, i) => { const child = children[i]; if(child) { const small = child.querySelector('small'); if(small) small.innerText = displayCat(c); } });
    }

    function startGameTrigger() {
        const letter = "ABC√áDEFGƒûHIƒ∞JKLMNO√ñPRS≈ûTU√úVYZ"[Math.floor(Math.random()*29)];
        db.ref(`rooms/${myRoomCode}`).update({ status: 'playing', letter: letter, time: parseInt(document.getElementById('time-slider').value), finishedCount: 0, answers: null, votes: null });
    }

    function startGameUI() {
        db.ref(`rooms/${myRoomCode}`).once('value').then(snap => {
            const data = snap.val() || {};
            currentLetter = data.letter || 'A';
            document.getElementById('let').innerText = currentLetter;
            currentCats = data.cats || currentCats;
            document.getElementById('inputs-area').innerHTML = currentCats.map(c => `
                <div style="margin-bottom:12px;">
                    <small style="color:var(--neon)">${displayCat(c)}</small>
                    <input type="text" id="ans-${c.replace(/\s/g,'_')}" class="input-box" style="text-align:left; margin:0; text-transform:uppercase;">
                </div>`).join('');
            const btn = document.getElementById('finish-btn'); btn.disabled = false; btn.style.opacity = "1";
            nav('sc-game');
            if(isAdmin) { clearInterval(timerInt); timerInt = setInterval(() => { db.ref(`rooms/${myRoomCode}/time`).transaction(t => (t > 0) ? t - 1 : 0); }, 1000); }
        });
    }

    function submitAnswers() {
        const btn = document.getElementById('finish-btn'); if(btn.disabled) return;
        const answers = {};
        currentCats.forEach(c => {
            const el = document.getElementById('ans-' + c.replace(/\s/g,'_'));
            const val = el ? el.value.trim().toUpperCase() : "";
            if(val && currentLetter && val.startsWith(currentLetter)) answers[c] = val; else answers[c] = "-";
        });
        btn.disabled = true; btn.style.opacity = "0.5";
        db.ref(`rooms/${myRoomCode}/answers/${myName}`).set(answers).then(() => { db.ref(`rooms/${myRoomCode}/finishedCount`).transaction(c => (c || 0) + 1); });
    }

    async function onBackFromGame() {
        if (currentStatus === 'playing') { const res = await showConfirm(); if(res !== 'yes') return; }
        clearInterval(timerInt);
        if(isAdmin) db.ref(`rooms/${myRoomCode}`).update({ status: 'lobby' });
        nav('sc-lobby');
    }

    function addCat() {
        const cRaw = document.getElementById('cat-in').value.trim(); if(!cRaw) return;
        const c = cRaw.toUpperCase();
        if(c && !currentCats.includes(c)) { currentCats.push(c); db.ref(`rooms/${myRoomCode}/cats`).set(currentCats); document.getElementById('cat-in').value = ""; }
    }
    function removeCat(i) { currentCats.splice(i,1); db.ref(`rooms/${myRoomCode}/cats`).set(currentCats); }

    function startReviewUI() {
        clearInterval(timerInt);
        try { if(votesRef && votesListener) votesRef.off('value', votesListener); } catch(e){}
        db.ref(`rooms/${myRoomCode}/answers`).once('value').then(snap => {
            const allAns = snap.val() || {}; let html = "";
            currentCats.forEach(cat => {
                html += `<div style="color:var(--neon); font-size:12px; font-weight:900; margin:15px 5px 5px 5px;">‚óè ${displayCat(cat)}</div>`;
                roomPlayers.forEach(p => {
                    const ans = (allAns[p] && allAns[p][cat]) ? allAns[p][cat] : "-";
                    const sid = `${cat.replace(/\s/g,'_')}_${p.replace(/\s/g,'_')}`;
                    html += `
                    <div class="vote-card" id="card-${sid}">
                        <div style="display:flex; justify-content:space-between;"><small>üë§ ${p}</small> <span id="vcount-${sid}">‚úî0 ‚úñ0</span></div>
                        <div style="font-size:18px; font-weight:bold; margin:10px 0;">${ans}</div>
                        <div style="display:flex; gap:10px;">
                            <button class="menu-btn" data-sid="${sid}" data-type="no" style="flex:1; margin:0;">${langDict[curLang].red}</button>
                            <button class="menu-btn" data-sid="${sid}" data-type="ok" style="flex:1; margin:0;">${langDict[curLang].ok}</button>
                        </div>
                    </div>`;
                });
            });
            document.getElementById('all-reviews-list').innerHTML = html;
            if(isAdmin) document.getElementById('admin-results-btn').classList.remove('hidden');
            nav('sc-review');
            const list = document.getElementById('all-reviews-list');
            list.onclick = function(e) {
                const btn = e.target.closest('button[data-sid]'); if(!btn) return;
                const sid = btn.getAttribute('data-sid'), type = btn.getAttribute('data-type');
                const card = document.getElementById(`card-${sid}`);
                if(card) {
                    const bno = card.querySelector('button[data-type="no"]'), bok = card.querySelector('button[data-type="ok"]');
                    if(bno) bno.classList.remove('active-no'); if(bok) bok.classList.add('active-ok');
                    if(type === 'ok' && bok) bok.classList.add('active-ok'); if(type === 'no' && bno) bno.classList.add('active-no');
                }
                localVotes[sid] = type;
                db.ref(`rooms/${myRoomCode}/votes/${sid}/${myName}`).set(type);
            };
            votesRef = db.ref(`rooms/${myRoomCode}/votes`);
            votesListener = function(vsnap) {
                const all = vsnap.val() || {};
                Object.keys(all).forEach(sid => {
                    const vObj = all[sid] || {}, v = Object.values(vObj), el = document.getElementById(`vcount-${sid}`);
                    if(el) el.innerText = `‚úî${v.filter(x=>x==='ok').length} ‚úñ${v.filter(x=>x==='no').length}`;
                    const card = document.getElementById(`card-${sid}`);
                    if(card) {
                        const bno = card.querySelector('button[data-type="no"]'), bok = card.querySelector('button[data-type="ok"]');
                        let finalVote = vObj[myName] || localVotes[sid];
                        if (bok) { if (finalVote === 'ok') bok.classList.add('active-ok'); else bok.classList.remove('active-ok'); }
                        if (bno) { if (finalVote === 'no') bno.classList.add('active-no'); else bno.classList.remove('active-no'); }
                    }
                });
            };
            votesRef.on('value', votesListener);
        });
    }

    async function showLeaderboard() {
        if(isAdmin) db.ref(`rooms/${myRoomCode}`).update({ status: 'results' });
        const snap = await db.ref(`rooms/${myRoomCode}`).once('value');
        const vts = snap.val().votes || {};
        let scores = {}; roomPlayers.forEach(p => scores[p] = 0);
        Object.keys(vts).forEach(vid => { 
            const parts = vid.split('_'), target = parts[parts.length-1].replace(/_/g, ' '), v = Object.values(vts[vid] || {}); 
            if(v.filter(x=>x==='ok').length >= v.filter(x=>x==='no').length) scores[target] = (scores[target] || 0) + 10; 
        });
        document.getElementById('final-ranks').innerHTML = Object.entries(scores).sort((a,b)=>b[1]-a[1]).map(s => `<div class="row-item"><span>${s[0]}</span><b>${s[1]} P</b></div>`).join('');
        confetti(); nav('sc-results');
    }

    function goToRoomLobby() { clearInterval(timerInt); nav('sc-lobby'); }
    async function goToMainMenu(confirmFirst) {
        if(confirmFirst) { const res = await showConfirm(); if(res !== 'yes') return; }
        clearInterval(timerInt); try{ if(prevRoomRef) { prevRoomRef.off(); } }catch(e){} nav('sc-main');
    }
    updateUILanguage();
</script>
</body>
</html>
